services:
  ccagent-token-rotator-test:
    image: preslavmihaylov/ccagent-token-rotator:latest
    container_name: ccagent-token-rotator-test
    volumes:
      - ./cc.pem:/secrets/cc.pem:ro
      - ./ccagent-test:/shared:Z
    environment:
      - GITHUB_APP_ID=1798229
      - GITHUB_INSTALLATION_ID=82568898
    healthcheck:
      test: ["CMD", "test", "-f", "/shared/.config/ccagent/.env"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  ccagent-test:
    image: preslavmihaylov/ccagent-docker:latest
    container_name: ccagent-test
    depends_on:
      ccagent-token-rotator-test:
        condition: service_healthy
    volumes:
      - ./ccagent-test:/home/ccagent
    environment:
      - REPO_URL=github.com/presmihaylov/claudecontrol
      - CCAGENT_API_KEY=sys_ajNc++GrTmQ+U2JyLx8Jg9XmCX9TxcG45xTSPBoVzwA=
      - CLAUDE_CODE_OAUTH_TOKEN=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
    working_dir: /workspace
    stdin_open: true
    tty: true
    restart: unless-stopped
